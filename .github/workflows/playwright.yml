name: Playwright Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Cache npm dependencies
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        run: npx playwright test

      - name: Upload HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-html-report
          path: playwright-report/html/
          retention-days: 14

      - name: Upload JUnit Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-junit-report
          path: playwright-report/results.xml
          retention-days: 14

      - name: Generate GitHub Annotations from JUnit report
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const xml2js = require('xml2js');

            // Parse the JUnit XML file
            const xmlData = fs.readFileSync('playwright-report/results.xml', 'utf8');
            const parser = new xml2js.Parser();
            parser.parseString(xmlData, (err, result) => {
              if (err) {
                console.error('Error parsing XML:', err);
                return;
              }

              const testsuites = result.testsuites.testsuite;
              testsuites.forEach(testsuite => {
                testsuite.testcase.forEach(testcase => {
                  // If the test has failed, add an annotation
                  if (testcase.failure || testcase.error) {
                    const testName = testcase.$.name;
                    const message = testcase.failure ? testcase.failure[0]._ : testcase.error[0]._ || 'Unknown error';
                    const line = testcase.$.line || 1;

                    // Create an annotation for each failed test
                    github.rest.repos.createCommitStatus({
                      ...context.repo,
                      sha: context.sha,
                      state: 'failure',
                      description: `Test failed: ${testName}`,
                      target_url: '',  // Optional URL if needed
                      context: 'Playwright Tests',
                    });

                    // Alternatively, you can create annotation here using:
                    // github.rest.repos.createCheckRunAnnotations({/* ... */})
                    core.setFailed(`Test failed: ${testName} - ${message}`);
                  }
                });
              });
            });
